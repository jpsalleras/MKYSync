@page
@model DbSync.Web.Pages.Compare.IndexModel
@using DbSync.Core.Models
@{
    ViewData["Title"] = "Comparar Ambientes";
}

@* ===== Compact Selector Toolbar ===== *@
<div class="compare-toolbar" id="compareToolbar">
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <h5 class="mb-0 me-2" style="font-size:1rem;white-space:nowrap">
            <i class="bi bi-file-diff"></i> Comparar
        </h5>
        <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="modoToggle" id="modoAmbiente" autocomplete="off"
                   @(Model.Modo == "ambiente" ? "checked" : "") onchange="setModo('ambiente')">
            <label class="btn btn-outline-primary" for="modoAmbiente">
                <i class="bi bi-hdd-stack"></i> Ambiente vs Ambiente
            </label>
            <input type="radio" class="btn-check" name="modoToggle" id="modoVersion" autocomplete="off"
                   @(Model.Modo == "version" ? "checked" : "") onchange="setModo('version')">
            <label class="btn btn-outline-primary" for="modoVersion">
                <i class="bi bi-tag"></i> Version Base vs Ambiente
            </label>
        </div>

        <div class="vr mx-1"></div>

        <form method="get" id="compareForm" class="d-flex align-items-center gap-1 flex-wrap mb-0">
            <input type="hidden" name="modo" id="modoInput" value="@Model.Modo" />

            @* Modo Ambiente *@
            <div class="d-flex align-items-center gap-1 @(Model.Modo != "ambiente" ? "d-none" : "")" id="selectorAmbiente">
                <select name="clienteId" asp-items="Model.ClientesList" class="form-select form-select-sm" id="selClienteAmb" title="Cliente" style="min-width:160px">
                    <option value="">-- Cliente --</option>
                </select>
                <select name="origen" class="form-select form-select-sm" id="selOrigen" title="Origen" style="width:80px">
                    <option value="DEV" selected="@(Model.Origen == "DEV")">DEV</option>
                    <option value="QA" selected="@(Model.Origen == "QA")">QA</option>
                    <option value="PR" selected="@(Model.Origen == "PR")">PR</option>
                </select>
                <i class="bi bi-arrow-right text-muted"></i>
                <select name="destino" class="form-select form-select-sm" id="selDestinoAmb" title="Destino" style="width:80px">
                    <option value="DEV" selected="@(Model.Destino == "DEV")">DEV</option>
                    <option value="QA" selected="@(Model.Destino == "QA")">QA</option>
                    <option value="PR" selected="@(Model.Destino == "PR")">PR</option>
                </select>
                <select name="tipo" class="form-select form-select-sm" id="selTipoAmb" title="Tipo" style="width:90px">
                    <option value="">Todos</option>
                    <option value="SP" selected="@(Model.Tipo == "SP")">SP</option>
                    <option value="VIEW" selected="@(Model.Tipo == "VIEW")">Vistas</option>
                    <option value="FN" selected="@(Model.Tipo == "FN")">Func.</option>
                </select>
            </div>

            @* Modo Version *@
            <div class="d-flex align-items-center gap-1 @(Model.Modo != "version" ? "d-none" : "")" id="selectorVersion">
                <select name="versionId" class="form-select form-select-sm" id="selVersionId" title="Version Base" style="min-width:160px">
                    <option value="">-- Version --</option>
                    @foreach (var v in Model.VersionesList)
                    {
                        <option value="@v.Value" selected="@v.Selected">@v.Text</option>
                    }
                </select>
                <select name="clienteId" asp-items="Model.ClientesList" class="form-select form-select-sm" id="selClienteVer" title="Cliente" style="min-width:160px">
                    <option value="">-- Cliente --</option>
                </select>
                <i class="bi bi-arrow-right text-muted"></i>
                <select name="destino" class="form-select form-select-sm" id="selDestinoVer" title="Destino" style="width:80px">
                    <option value="DEV" selected="@(Model.Destino == "DEV")">DEV</option>
                    <option value="QA" selected="@(Model.Destino == "QA")">QA</option>
                    <option value="PR" selected="@(Model.Destino == "PR")">PR</option>
                </select>
                <select name="tipo" class="form-select form-select-sm" id="selTipoVer" title="Tipo" style="width:90px">
                    <option value="">Todos</option>
                    <option value="SP" selected="@(Model.Tipo == "SP")">SP</option>
                    <option value="VIEW" selected="@(Model.Tipo == "VIEW")">Vistas</option>
                    <option value="FN" selected="@(Model.Tipo == "FN")">Func.</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary btn-sm" data-loading="Comparando..." data-overlay>
                <i class="bi bi-search"></i> Comparar
            </button>
        </form>

        <div class="ms-auto d-flex gap-1">
            <button type="button" class="btn btn-outline-secondary btn-sm btn-layout-toggle" id="btnLayoutToggle"
                    onclick="toggleLayout()" title="Cambiar disposicion">
                <i class="bi bi-layout-split" id="layoutIcon"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="history.back()" title="Volver">
                <i class="bi bi-arrow-left"></i>
            </button>
        </div>
    </div>
</div>

@* ===== Error Modals ===== *@
@if (Model.ErrorMessage != null)
{
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">@Model.ErrorMessage</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.SyncErrorMessage != null)
{
    <div class="modal fade" id="syncErrorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Error de Sincronizacion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">@Model.SyncErrorMessage</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@* ===== Resultados de sincronizacion ===== *@
@if (Model.MostrarResultadosSync && Model.SyncResults.Any())
{
    var successCount = Model.SyncResults.Count(r => r.Success);
    var errorCount = Model.SyncResults.Count(r => !r.Success);

    <div class="card mb-3 @(errorCount > 0 ? "border-danger" : "border-success")">
        <div class="card-header @(errorCount > 0 ? "bg-danger" : "bg-success") text-white d-flex justify-content-between align-items-center">
            <span>
                <i class="bi @(errorCount > 0 ? "bi-x-circle" : "bi-check-circle")"></i>
                Resultado de Sincronizacion
            </span>
            <div>
                <span class="badge bg-light text-success">@successCount exitosos</span>
                @if (errorCount > 0)
                {
                    <span class="badge bg-light text-danger ms-1">@errorCount errores</span>
                }
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:40px"></th>
                        <th>Objeto</th>
                        <th style="width:80px">Accion</th>
                        <th>Mensaje</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.SyncResults)
                    {
                        <tr class="@(r.Success ? "" : "table-danger")">
                            <td class="text-center">
                                @if (r.Success)
                                {
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                }
                            </td>
                            <td><code>@r.ObjectFullName</code></td>
                            <td><span class="badge @(r.Action == "ERROR" ? "bg-danger" : "bg-info")">@r.Action</span></td>
                            <td class="small">@r.Message</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer text-end">
            <a href="/Sync/History?clienteId=@Model.ClienteId" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-clock-history"></i> Ver Historial Completo
            </a>
            <a href="/Compare?clienteId=@Model.ClienteId&origen=@Model.Origen&destino=@Model.Destino&tipo=@Model.Tipo&modo=@Model.Modo@(Model.IsVersionMode ? $"&versionId={Model.VersionId}" : "")"
               class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-repeat"></i> Comparar de Nuevo
            </a>
        </div>
    </div>
}

@* ===== Preview de sincronizacion ===== *@
@if (Model.MostrarPreviewSync && Model.PreviewSummary != null)
{
    <div class="card mb-3 border-warning">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <span><i class="bi bi-exclamation-triangle"></i> Preview de Sincronizacion - Confirmar antes de ejecutar</span>
            <span class="badge bg-dark">@Model.PreviewSummary.Total objetos</span>
        </div>
        <div class="card-body">
            <div class="mb-2">
                @if (Model.PreviewSummary.TotalCreate > 0)
                {
                    <span class="badge bg-primary me-1">@Model.PreviewSummary.TotalCreate CREATE</span>
                }
                @if (Model.PreviewSummary.TotalAlter > 0)
                {
                    <span class="badge bg-warning text-dark me-1">@Model.PreviewSummary.TotalAlter ALTER</span>
                }
                @if (Model.PreviewSummary.TotalDrop > 0)
                {
                    <span class="badge bg-danger me-1">@Model.PreviewSummary.TotalDrop DROP</span>
                }
            </div>

            @if (Model.IncludesDrops)
            {
                <div class="d-flex align-items-start gap-2 text-danger mb-2">
                    <i class="bi bi-exclamation-octagon fs-5 mt-1"></i>
                    <span><strong>ATENCION:</strong> La seleccion incluye @Model.PreviewSummary.TotalDrop objeto(s) que seran ELIMINADOS del destino.</span>
                </div>
            }
            @if (Model.IncludesCustom)
            {
                <div class="d-flex align-items-start gap-2 text-warning mb-2">
                    <i class="bi bi-exclamation-triangle fs-5 mt-1"></i>
                    <span>La seleccion incluye @Model.PreviewSummary.TotalCustom objeto(s) custom. Proceda con precaucion.</span>
                </div>
            }

            <div class="mb-2" style="max-height: calc(100vh - 450px); overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Objeto</th>
                            <th style="width:100px">Accion</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.PreviewSummary.Items)
                        {
                            var actionBadge = item.Action switch
                            {
                                "CREATE" => "bg-primary",
                                "ALTER" => "bg-warning text-dark",
                                "DROP" => "bg-danger",
                                _ => "bg-secondary"
                            };
                            <tr class="@(item.IsCustom ? "table-warning" : "")">
                                <td>
                                    <code>@item.Name</code>
                                    @if (item.IsCustom)
                                    {
                                        <span class="badge badge-custom text-white ms-1" style="font-size:0.6rem">CUSTOM</span>
                                    }
                                </td>
                                <td><span class="badge @actionBadge">@item.Action</span></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mb-3" id="scriptSection">
                <div class="d-flex align-items-center gap-1 mb-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleScript()" id="btnToggleScript">
                        <i class="bi bi-code-square"></i> Ver script SQL
                    </button>
                    <div id="scriptToolbar" class="btn-group btn-group-sm" style="display:none">
                        <button type="button" class="btn btn-outline-secondary" onclick="copyScript(this)" title="Copiar al portapapeles">
                            <i class="bi bi-clipboard"></i> Copiar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleScriptExpand()" id="btnScriptExpand" title="Expandir">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>
                </div>
                <div id="scriptPanel" style="display:none; position:relative;">
                    <button type="button" id="btnScriptClose" class="btn btn-sm btn-outline-light position-absolute" style="display:none; top:8px; right:8px; z-index:10000; opacity:0.8;"
                            onclick="toggleScriptExpand()" title="Cerrar (Esc)">
                        <i class="bi bi-x-lg"></i> Cerrar
                    </button>
                    <pre id="scriptPreviewCode" class="border rounded p-2" style="max-height: calc(100vh - 350px); overflow:auto; font-size:0.75rem; background:#1e1e1e; color:#d4d4d4; tab-size:4;">@Model.ScriptPreview</pre>
                </div>
            </div>

            <div class="d-flex gap-2">
                @if (Model.CanExecute)
                {
                    <form method="post" asp-page-handler="ExecuteSync" id="executeSyncForm">
                        <input type="hidden" name="ClienteId" value="@Model.ClienteId" />
                        <input type="hidden" name="Origen" value="@Model.Origen" />
                        <input type="hidden" name="Destino" value="@Model.Destino" />
                        <input type="hidden" name="Tipo" value="@Model.Tipo" />
                        <input type="hidden" name="Modo" value="@Model.Modo" />
                        @if (Model.IsVersionMode)
                        {
                            <input type="hidden" name="VersionId" value="@Model.VersionId" />
                        }
                        @foreach (var obj in Model.SelectedObjects)
                        {
                            <input type="hidden" name="SelectedObjects" value="@obj" />
                        }
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmSyncModal">
                            <i class="bi bi-play-fill"></i> Confirmar y Ejecutar
                        </button>
                    </form>
                }
                else
                {
                    <div class="alert alert-info py-2 px-3 mb-0">
                        <i class="bi bi-lock"></i> No tiene permisos para ejecutar. Solicite el rol <strong>Ejecutar</strong> para sincronizar.
                    </div>
                }
                <a href="/Compare?clienteId=@Model.ClienteId&origen=@Model.Origen&destino=@Model.Destino&tipo=@Model.Tipo&modo=@Model.Modo@(Model.IsVersionMode ? $"&versionId={Model.VersionId}" : "")"
                   class="btn btn-outline-secondary">
                    Cancelar
                </a>
            </div>

    @if (Model.CanExecute)
    {
        <div class="modal fade" id="confirmSyncModal" tabindex="-1" aria-labelledby="confirmSyncModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="confirmSyncModalLabel">
                            <i class="bi bi-exclamation-triangle"></i> Confirmar Sincronizacion
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p>Esta a punto de ejecutar la sincronizacion de <strong>@Model.PreviewSummary.Total objeto(s)</strong> de <strong>@Model.OrigenLabel</strong> a <strong>@Model.Destino</strong>.</p>
                        @if (Model.IncludesDrops)
                        {
                            <div class="d-flex align-items-start gap-2 text-danger mb-2">
                                <i class="bi bi-exclamation-octagon fs-5 mt-1"></i>
                                <span>Se ELIMINARAN <strong>@Model.PreviewSummary.TotalDrop objeto(s)</strong> del destino.</span>
                            </div>
                        }
                        @if (Model.IncludesCustom)
                        {
                            <div class="d-flex align-items-start gap-2 text-warning mb-2">
                                <i class="bi bi-exclamation-triangle fs-5 mt-1"></i>
                                <span>La seleccion incluye <strong>@Model.PreviewSummary.TotalCustom objeto(s) custom</strong>.</span>
                            </div>
                        }
                        <p class="mb-0 text-muted"><small>Esta accion modifica la base de datos destino. Los cambios se ejecutan dentro de una transaccion.</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="btnConfirmSync" onclick="executeSync()">
                            <i class="bi bi-play-fill"></i> Ejecutar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
        </div>
    </div>
}

@if (Model.Summary != null && !Model.MostrarPreviewSync && !Model.MostrarResultadosSync)
{
    @* ===== Filter badges + Sync toolbar (merged into one bar) ===== *@
    <div class="compare-filters-bar" id="filtersBar">
        <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="badge bg-success stat-badge" role="button" onclick="filterStatus('Equal')">
                @Model.Summary.TotalEqual Iguales
            </span>
            <span class="badge bg-warning text-dark stat-badge" role="button" onclick="filterStatus('Modified')">
                @Model.Summary.TotalModified Modificados
            </span>
            <span class="badge bg-primary stat-badge" role="button" onclick="filterStatus('OnlyInSource')">
                @Model.Summary.TotalOnlyInSource Solo @Model.OrigenLabel
            </span>
            <span class="badge bg-danger stat-badge" role="button" onclick="filterStatus('OnlyInTarget')">
                @Model.Summary.TotalOnlyInTarget Solo @Model.Destino
            </span>
            <span class="badge stat-badge" style="background:#6f42c1" role="button" onclick="filterStatus('Custom')">
                @Model.Summary.TotalCustom Custom
            </span>

            @{
                var showCheckboxes = Model.CanSync && Model.Summary.HasDifferences
                    && !Model.MostrarPreviewSync && !Model.MostrarResultadosSync;
            }

            @if (showCheckboxes)
            {
                <div class="vr mx-1"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary py-0" onclick="selectAllSync(true)" style="font-size:0.75rem">
                    Todos
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary py-0" onclick="selectAllSync(false)" style="font-size:0.75rem">
                    Ninguno
                </button>
                <span class="text-muted small" id="syncSelectionCount"></span>
                <button type="button" class="btn btn-warning btn-sm fw-semibold shadow-sm"
                        data-loading="Generando preview..." data-overlay
                        id="btnPreviewSync" onclick="submitSyncForm()" style="font-size:0.78rem">
                    <i class="bi bi-arrow-right-circle-fill"></i> Sync (@Model.OrigenLabel &rarr; @Model.Destino)
                </button>
            }

            <span class="text-muted small ms-auto">
                @Model.Summary.TotalObjects obj en @Model.Summary.Duracion.TotalSeconds.ToString("F1")s
            </span>
        </div>
    </div>

    @if (showCheckboxes)
    {
        <form method="post" asp-page-handler="PreviewSync" id="syncForm">
            <input type="hidden" name="ClienteId" value="@Model.ClienteId" />
            <input type="hidden" name="Origen" value="@Model.Origen" />
            <input type="hidden" name="Destino" value="@Model.Destino" />
            <input type="hidden" name="Tipo" value="@Model.Tipo" />
            <input type="hidden" name="Modo" value="@Model.Modo" />
            @if (Model.IsVersionMode)
            {
                <input type="hidden" name="VersionId" value="@Model.VersionId" />
            }
            <div id="syncHiddenInputs"></div>
        </form>
    }

    @* ===== Split Layout (dual mode: horizontal / vertical) ===== *@
    <div id="splitContainer" class="compare-split split-horizontal">

        @* --- Object Panel --- *@
        <div id="objectPanel" class="compare-objects" style="height:38%">
            <div class="object-grid-toolbar">
                <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="Buscar objeto..." />
                <span id="gridRowCount" class="small text-muted"></span>
            </div>
            <div class="object-grid-scroll">
                <table id="objectGrid" class="table table-sm table-hover mb-0 sortable-table">
                    <thead class="table-light">
                        <tr>
                            @if (showCheckboxes)
                            {
                                <th style="width:28px" data-no-sort>
                                    <input type="checkbox" class="form-check-input" id="chkSelectAll"
                                           onclick="selectAllSync(this.checked)" title="Seleccionar todos" />
                                </th>
                            }
                            <th style="width:28px" data-no-sort class="col-wide-only text-center">Tipo</th>
                            <th>Objeto</th>
                            <th style="width:70px">Estado</th>
                            <th style="width:80px" data-sort-type="number" class="col-wide-only">+/-</th>
                            <th style="width:115px" data-sort-type="number" data-sort-default="desc" class="col-wide-only">Modificado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in Model.Summary.Results
                            .Where(r => r.Status != CompareStatus.Equal)
                            .OrderByDescending(r => r.Source?.LastModified ?? r.Target?.LastModified ?? DateTime.MinValue))
                        {
                            var statusBadge = result.Status switch
                            {
                                CompareStatus.Modified => "badge-modified",
                                CompareStatus.OnlyInSource => "badge-only-source",
                                CompareStatus.OnlyInTarget => "badge-only-target",
                                _ => ""
                            };
                            var statusText = result.Status switch
                            {
                                CompareStatus.Modified => "MOD",
                                CompareStatus.OnlyInSource => $"SOLO {Model.OrigenLabel}",
                                CompareStatus.OnlyInTarget => $"SOLO {Model.Destino}",
                                _ => ""
                            };
                            var typeIcon = result.ObjectType switch
                            {
                                DbObjectType.StoredProcedure => "bi-filetype-sql",
                                DbObjectType.View => "bi-table",
                                _ => "bi-braces"
                            };
                            var typeLabel = result.ObjectType.ToShortCode();
                            var lastMod = result.Source?.LastModified ?? result.Target?.LastModified;
                            var hasDate = lastMod.HasValue && lastMod.Value != default(DateTime);

                            <tr class="object-row" data-status="@result.Status" data-name="@result.ObjectFullName"
                                onclick="showDiff(this.dataset.name)">
                                @if (showCheckboxes)
                                {
                                    <td class="text-center" onclick="event.stopPropagation()">
                                        <input type="checkbox" class="form-check-input sync-checkbox"
                                               data-object-name="@result.ObjectFullName"
                                               @(result.IsCustom ? "disabled" : "")
                                               onchange="updateSyncCount()" />
                                    </td>
                                }
                                <td class="text-center col-wide-only" title="@typeLabel">
                                    <i class="bi @typeIcon text-muted"></i>
                                </td>
                                <td>
                                    <code class="small">@result.ObjectFullName</code>
                                    @if (result.IsCustom)
                                    {
                                        <span class="badge badge-custom text-white ms-1" style="font-size:0.55rem">C</span>
                                    }
                                    <span class="col-narrow-only text-muted" style="font-size:0.7rem">
                                        &mdash; @typeLabel
                                        @if (hasDate)
                                        {
                                            <text> &middot; @lastMod.Value.ToString("dd/MM HH:mm")</text>
                                        }
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @statusBadge text-white" style="font-size:0.6rem">@statusText</span>
                                </td>
                                <td class="small text-muted col-wide-only" style="white-space:nowrap" data-sort-value="@(result.LinesAdded + result.LinesRemoved)">
                                    @if (result.Status == CompareStatus.Modified)
                                    {
                                        <span class="text-success">+@result.LinesAdded</span>
                                        <span class="text-danger">-@result.LinesRemoved</span>
                                    }
                                </td>
                                <td class="small text-muted col-wide-only" data-sort-value="@(hasDate ? lastMod.Value.ToString("yyyyMMddHHmm") : "")">
                                    @if (hasDate)
                                    {
                                        @lastMod.Value.ToString("dd/MM/yy HH:mm")
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @* --- Gutter (horizontal bar / vertical divider) --- *@
        <div id="splitGutter" class="compare-gutter">
            <div id="gutterBar" class="gutter-bar">
                <span id="diffTitle" class="gutter-object-name">Seleccione un objeto</span>
                <div id="diffControls" class="gutter-controls">
                    <div class="btn-group btn-group-sm" id="grpCopyMerge" style="display:none">
                        <button type="button" class="btn btn-outline-secondary" id="btnCopySource"
                                onclick="copyDiffSide(0, this)" title="Copiar @Model.OrigenLabel">
                            <i class="bi bi-clipboard"></i> @Model.OrigenLabel
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnCopyTarget"
                                onclick="copyDiffSide(1, this)" title="Copiar @Model.Destino">
                            <i class="bi bi-clipboard"></i> @Model.Destino
                        </button>
                        @if (Model.MergeEnabled)
                        {
                            <button type="button" class="btn btn-outline-primary" id="btnSuggestMerge"
                                    onclick="suggestMerge()" title="Sugerir merge con IA" style="display:none">
                                <i class="bi bi-stars"></i> Merge
                            </button>
                        }
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" id="btnPrevDiff" onclick="prevDiff()" title="Diferencia anterior" disabled>
                            <i class="bi bi-chevron-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnDiffCount" disabled style="font-size:0.7rem;min-width:50px">
                            0/0
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnNextDiff" onclick="nextDiff()" title="Diferencia siguiente" disabled>
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnToggleExpand" onclick="toggleExpand()" title="Expandir/Contraer">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @* --- Diff Panel --- *@
        <div id="diffPanel" class="compare-diff" style="flex:1">
            @* Header shown only in vertical mode *@
            <div id="diffHeaderV" class="diff-header-v">
                @* Controls will be moved here via JS in vertical mode *@
            </div>
            <div class="diff-container" id="diffContainer" data-no-copy-btns style="overflow: auto; flex: 1;">
                <p class="text-muted p-3">Seleccione un objeto para ver las diferencias.</p>
            </div>
        </div>
    </div>
}
else if (Model.ErrorMessage == null && Model.SyncErrorMessage == null && !Model.MostrarResultadosSync)
{
    @* No mostrar nada extra *@
}

@* Modal de Sugerencia de Merge (IA) *@
@if (Model.MergeEnabled)
{
    @Html.AntiForgeryToken()
    <div class="modal fade" id="mergeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-stars"></i> Sugerencia de Merge (IA)
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div id="mergeLoading" class="text-center p-4">
                        <div class="spinner-border text-info" style="width:2rem;height:2rem"></div>
                        <p class="mt-2 text-muted">Consultando a Claude... Esto puede tardar unos segundos.</p>
                    </div>
                    <div id="mergeError" class="alert alert-danger" style="display:none"></div>
                    <div id="mergeResult" style="display:none">
                        <div id="mergeExplanation" class="alert alert-info mb-3"></div>
                        <div class="position-relative">
                            <button type="button" class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2"
                                    onclick="copyMergedSql(this)" title="Copiar al portapapeles">
                                <i class="bi bi-clipboard"></i> Copiar SQL
                            </button>
                            <pre id="mergeSqlCode" class="merge-sql-code border rounded p-3 pe-5"></pre>
                        </div>
                        <div class="text-muted small mt-2" id="mergeTokenInfo"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    // ===== Diff data =====
    var diffs = {};
    @if (Model.Summary != null)
    {
        foreach (var result in Model.Summary.Results.Where(r => r.DiffHtml != null))
        {
            <text>diffs['@result.ObjectFullName'] = `@Html.Raw(result.DiffHtml?.Replace("`", "\\`").Replace("\\", "\\\\") ?? "")` ;</text>
        }
    }

    // ===== Layout management =====
    var currentLayout = localStorage.getItem('compareLayout') || 'horizontal';

    function initLayout() {
        var container = document.getElementById('splitContainer');
        if (!container) return;
        applyLayout(currentLayout);
    }

    function applyLayout(layout) {
        var container = document.getElementById('splitContainer');
        if (!container) return;
        currentLayout = layout;

        var objectPanel = document.getElementById('objectPanel');
        var controls = document.getElementById('diffControls');
        var diffTitle = document.getElementById('diffTitle');
        var gutterBar = document.getElementById('gutterBar');
        var diffHeaderV = document.getElementById('diffHeaderV');
        var icon = document.getElementById('layoutIcon');

        if (layout === 'horizontal') {
            container.classList.remove('split-vertical');
            container.classList.add('split-horizontal');
            objectPanel.style.height = objectPanel.style.height || '38%';
            objectPanel.style.width = '';
            // Move controls to gutter bar
            if (gutterBar && controls) gutterBar.appendChild(controls);
            if (gutterBar && diffTitle) gutterBar.insertBefore(diffTitle, controls);
            if (icon) icon.className = 'bi bi-layout-sidebar';
        } else {
            container.classList.remove('split-horizontal');
            container.classList.add('split-vertical');
            objectPanel.style.width = objectPanel.style.width || '35%';
            objectPanel.style.height = '';
            // Move controls to diff header
            if (diffHeaderV && controls) diffHeaderV.appendChild(controls);
            if (diffHeaderV && diffTitle) diffHeaderV.insertBefore(diffTitle, controls);
            if (icon) icon.className = 'bi bi-layout-split';
        }
    }

    function toggleLayout() {
        var newLayout = currentLayout === 'horizontal' ? 'vertical' : 'horizontal';
        applyLayout(newLayout);
        localStorage.setItem('compareLayout', newLayout);
    }

    // ===== Show diff =====
    function showDiff(objectName) {
        var titleEl = document.getElementById('diffTitle');
        if (titleEl) titleEl.textContent = objectName;

        var html = diffs[objectName];
        var diffContainer = document.getElementById('diffContainer');
        if (html) {
            diffContainer.innerHTML = html;
        } else {
            diffContainer.innerHTML = '<p class="text-muted p-3">Este objeto no tiene diff (solo existe en un ambiente).</p>';
        }

        // Mark selected row
        document.querySelectorAll('#objectGrid .object-row').forEach(function(r) { r.classList.remove('selected'); });
        var selectedRow = document.querySelector('#objectGrid [data-name="' + objectName + '"]');
        if (selectedRow) selectedRow.classList.add('selected');

        // Show copy/merge button group when a diff is loaded
        var grpCopyMerge = document.getElementById('grpCopyMerge');
        if (grpCopyMerge) grpCopyMerge.style.display = html ? '' : 'none';

        // Show merge button only for Modified objects
        var mergeBtn = document.getElementById('btnSuggestMerge');
        if (mergeBtn) {
            mergeBtn.style.display = (selectedRow && selectedRow.dataset.status === 'Modified') ? '' : 'none';
        }

        initDiffNav();
    }

    // ===== Diff navigation =====
    var diffRows = [];
    var diffIndex = -1;

    function initDiffNav() {
        var container = document.getElementById('diffContainer');
        diffRows = container.querySelectorAll('.diff-deleted, .diff-inserted, .diff-modified');
        diffIndex = -1;
        updateDiffNavUI();
        if (diffRows.length > 0) nextDiff();
    }

    function nextDiff() {
        if (diffRows.length === 0) return;
        diffIndex++;
        if (diffIndex >= diffRows.length) diffIndex = 0;
        scrollToDiff();
    }

    function prevDiff() {
        if (diffRows.length === 0) return;
        diffIndex--;
        if (diffIndex < 0) diffIndex = diffRows.length - 1;
        scrollToDiff();
    }

    function scrollToDiff() {
        diffRows.forEach(function(r) { r.closest('tr')?.classList.remove('diff-highlight'); });
        var row = diffRows[diffIndex];
        var tr = row.closest('tr');
        if (tr) {
            tr.classList.add('diff-highlight');
            tr.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
        updateDiffNavUI();
    }

    function updateDiffNavUI() {
        var total = diffRows.length;
        var prev = document.getElementById('btnPrevDiff');
        var next = document.getElementById('btnNextDiff');
        var count = document.getElementById('btnDiffCount');
        if (prev) prev.disabled = total === 0;
        if (next) next.disabled = total === 0;
        if (count) count.textContent = total > 0 ? (diffIndex + 1) + '/' + total : '0/0';
    }

    // ===== Expand / Contract =====
    var expanded = false;
    function toggleExpand() {
        var objectPanel = document.getElementById('objectPanel');
        var gutter = document.getElementById('splitGutter');
        var splitContainer = document.getElementById('splitContainer');
        var icon = document.querySelector('#btnToggleExpand i');
        var toolbar = document.getElementById('compareToolbar');
        var filtersBar = document.getElementById('filtersBar');
        var syncForm = document.getElementById('syncForm');

        expanded = !expanded;
        if (expanded) {
            if (objectPanel) objectPanel.style.display = 'none';
            if (currentLayout === 'vertical' && gutter) gutter.style.display = 'none';
            if (icon) icon.className = 'bi bi-arrows-angle-contract';
            if (toolbar) toolbar.style.display = 'none';
            if (filtersBar) filtersBar.style.display = 'none';
            if (syncForm) syncForm.style.display = 'none';
            if (splitContainer) splitContainer.style.height = 'calc(100vh - 50px)';
        } else {
            if (objectPanel) objectPanel.style.display = '';
            if (gutter) gutter.style.display = '';
            if (icon) icon.className = 'bi bi-arrows-fullscreen';
            if (toolbar) toolbar.style.display = '';
            if (filtersBar) filtersBar.style.display = '';
            if (syncForm) syncForm.style.display = '';
            if (splitContainer) splitContainer.style.height = '';
        }
    }

    // ===== Filtering =====
    function filterStatus(status) {
        document.querySelectorAll('#objectGrid .object-row').forEach(function(row) {
            if (status === 'Custom') {
                row.style.display = row.querySelector('.badge-custom') ? '' : 'none';
            } else {
                row.style.display = (row.dataset.status === status || status === '') ? '' : 'none';
            }
        });
        updateSyncCount();
        updateGridRowCount();
    }

    function updateGridRowCount() {
        var visible = document.querySelectorAll('#objectGrid .object-row:not([style*="display: none"])').length;
        var total = document.querySelectorAll('#objectGrid .object-row').length;
        var el = document.getElementById('gridRowCount');
        if (el) el.textContent = visible === total ? total + ' objetos' : visible + ' de ' + total;
    }

    // Search
    document.getElementById('searchBox')?.addEventListener('input', function(e) {
        var term = e.target.value.toLowerCase();
        document.querySelectorAll('#objectGrid .object-row').forEach(function(row) {
            row.style.display = row.dataset.name.toLowerCase().includes(term) ? '' : 'none';
        });
        updateSyncCount();
        updateGridRowCount();
    });

    // ===== Splitter drag (adapts to layout mode) =====
    (function() {
        var gutter = document.getElementById('splitGutter');
        var container = document.getElementById('splitContainer');
        var objectPanel = document.getElementById('objectPanel');
        if (!gutter || !container || !objectPanel) return;
        var dragging = false;

        gutter.addEventListener('mousedown', function(e) {
            e.preventDefault();
            dragging = true;
            document.body.style.userSelect = 'none';
            document.body.style.cursor = currentLayout === 'horizontal' ? 'row-resize' : 'col-resize';
        });

        document.addEventListener('mousemove', function(e) {
            if (!dragging) return;
            var rect = container.getBoundingClientRect();

            if (currentLayout === 'horizontal') {
                var y = e.clientY - rect.top;
                var pct = (y / rect.height) * 100;
                if (pct < 15) pct = 15;
                if (pct > 75) pct = 75;
                objectPanel.style.height = pct + '%';
                objectPanel.style.flex = 'none';
            } else {
                var x = e.clientX - rect.left;
                var pct = (x / rect.width) * 100;
                if (pct < 15) pct = 15;
                if (pct > 70) pct = 70;
                objectPanel.style.width = pct + '%';
            }
        });

        document.addEventListener('mouseup', function() {
            if (dragging) {
                dragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
    })();

    // ===== Sync checkbox management =====
    function updateSyncCount() {
        var checkboxes = document.querySelectorAll('.sync-checkbox:not(:disabled)');
        if (checkboxes.length === 0) return;
        var checked = 0;
        var total = 0;
        checkboxes.forEach(function(cb) {
            var row = cb.closest('.object-row');
            if (row && row.style.display !== 'none') {
                total++;
                if (cb.checked) checked++;
            }
        });
        var el = document.getElementById('syncSelectionCount');
        if (el) el.textContent = checked + ' de ' + total + ' seleccionados';

        var btn = document.getElementById('btnPreviewSync');
        if (btn) btn.disabled = checked === 0;
    }

    function selectAllSync(select) {
        document.querySelectorAll('.sync-checkbox:not(:disabled)').forEach(function(cb) {
            var row = cb.closest('.object-row');
            if (row && row.style.display !== 'none') {
                cb.checked = select;
            }
        });
        updateSyncCount();
        // Update header checkbox
        var chkAll = document.getElementById('chkSelectAll');
        if (chkAll) chkAll.checked = select;
    }

    function copyScript(btn) {
        var text = document.getElementById('scriptPreviewCode')?.textContent || '';
        navigator.clipboard.writeText(text).then(function() {
            var icon = btn.querySelector('i');
            icon.className = 'bi bi-clipboard-check';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            setTimeout(function() {
                icon.className = 'bi bi-clipboard';
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        });
    }

    var scriptExpanded = false;
    function toggleScript() {
        var panel = document.getElementById('scriptPanel');
        var toolbar = document.getElementById('scriptToolbar');
        var btn = document.getElementById('btnToggleScript');
        var visible = panel.style.display !== 'none';
        panel.style.display = visible ? 'none' : '';
        toolbar.style.display = visible ? 'none' : '';
        btn.innerHTML = visible
            ? '<i class="bi bi-code-square"></i> Ver script SQL'
            : '<i class="bi bi-code-square"></i> Ocultar script';
    }

    function toggleScriptExpand() {
        var pre = document.getElementById('scriptPreviewCode');
        var btn = document.getElementById('btnScriptExpand');
        var closeBtn = document.getElementById('btnScriptClose');
        scriptExpanded = !scriptExpanded;
        if (scriptExpanded) {
            pre.style.maxHeight = 'none';
            pre.style.position = 'fixed';
            pre.style.top = '0';
            pre.style.left = '0';
            pre.style.width = '100%';
            pre.style.height = '100%';
            pre.style.zIndex = '9999';
            pre.style.borderRadius = '0';
            pre.style.margin = '0';
            btn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
            closeBtn.style.display = '';
        } else {
            pre.style.maxHeight = 'calc(100vh - 350px)';
            pre.style.position = '';
            pre.style.top = '';
            pre.style.left = '';
            pre.style.width = '';
            pre.style.height = '';
            pre.style.zIndex = '';
            pre.style.borderRadius = '';
            pre.style.margin = '';
            btn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
            closeBtn.style.display = 'none';
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && scriptExpanded) {
            toggleScriptExpand();
        }
    });

    // Copy source (side=0) or target (side=1) from the current diff table
    function copyDiffSide(side, btn) {
        var table = document.querySelector('#diffContainer .diff-table');
        if (!table) return;
        // colIndex: source content is col 1, target content is col 3
        var colIndex = side === 0 ? 1 : 3;
        var lines = [];
        table.querySelectorAll('tbody tr').forEach(function(tr) {
            var td = tr.cells[colIndex];
            if (!td || td.classList.contains('diff-imaginary')) return;
            var pre = td.querySelector('pre');
            if (pre) lines.push(pre.textContent);
        });
        navigator.clipboard.writeText(lines.join('\n')).then(function() {
            var icon = btn.querySelector('i');
            icon.className = 'bi bi-clipboard-check';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            setTimeout(function() {
                icon.className = 'bi bi-clipboard';
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        });
    }

    function submitSyncForm() {
        var container = document.getElementById('syncHiddenInputs');
        if (!container) return;
        container.innerHTML = '';

        document.querySelectorAll('.sync-checkbox:checked:not(:disabled)').forEach(function(cb) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'SelectedObjects';
            input.value = cb.dataset.objectName;
            container.appendChild(input);
        });

        var form = document.getElementById('syncForm');
        if (form) form.submit();
    }

    function executeSync() {
        var modal = bootstrap.Modal.getInstance(document.getElementById('confirmSyncModal'));
        if (modal) modal.hide();

        var overlay = document.getElementById('spinnerOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'spinnerOverlay';
            overlay.className = 'spinner-overlay';
            overlay.innerHTML = '<div class="spinner-border text-primary" style="width:2.5rem;height:2.5rem"></div>' +
                '<div class="spinner-text">Ejecutando sincronizacion...</div>';
            document.body.appendChild(overlay);
        } else {
            var textEl = overlay.querySelector('.spinner-text');
            if (textEl) textEl.textContent = 'Ejecutando sincronizacion...';
        }
        overlay.classList.add('active');

        setTimeout(function() {
            var form = document.getElementById('executeSyncForm');
            if (form) form.submit();
        }, 300);
    }

    // ===== Keyboard navigation =====
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
        if (!document.getElementById('splitContainer')) return;

        var rows = Array.from(document.querySelectorAll('#objectGrid .object-row'))
            .filter(function(r) { return r.style.display !== 'none'; });
        if (rows.length === 0) return;

        var currentIdx = rows.findIndex(function(r) { return r.classList.contains('selected'); });

        if (e.key === 'ArrowDown' || e.key === 'j') {
            e.preventDefault();
            var next = currentIdx < rows.length - 1 ? currentIdx + 1 : 0;
            rows[next].click();
            rows[next].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp' || e.key === 'k') {
            e.preventDefault();
            var prev = currentIdx > 0 ? currentIdx - 1 : rows.length - 1;
            rows[prev].click();
            rows[prev].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'n') {
            nextDiff();
        } else if (e.key === 'p') {
            prevDiff();
        } else if (e.key === 'Escape' && expanded) {
            toggleExpand();
        } else if (e.key === 'f' && !expanded) {
            toggleExpand();
        }
    });

    // ===== Mode toggle =====
    function setModo(modo) {
        document.getElementById('modoInput').value = modo;
        document.getElementById('selectorAmbiente').classList.toggle('d-none', modo !== 'ambiente');
        document.getElementById('selectorVersion').classList.toggle('d-none', modo !== 'version');
        document.querySelectorAll('#selectorAmbiente select').forEach(function(s) { s.disabled = modo !== 'ambiente'; });
        document.querySelectorAll('#selectorVersion select').forEach(function(s) { s.disabled = modo !== 'version'; });
    }
    setModo('@Model.Modo');

    // ===== Merge suggestion (AI) =====
    function suggestMerge() {
        var objectName = document.getElementById('diffTitle').textContent;
        if (!objectName || objectName === 'Seleccione un objeto') return;

        var modal = new bootstrap.Modal(document.getElementById('mergeModal'));
        document.getElementById('mergeLoading').style.display = '';
        document.getElementById('mergeError').style.display = 'none';
        document.getElementById('mergeResult').style.display = 'none';
        modal.show();

        var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        var params = new URLSearchParams();
        params.append('clienteId', '@(Model.ClienteId ?? 0)');
        params.append('origen', '@Model.Origen');
        params.append('destino', '@Model.Destino');
        params.append('objectName', objectName);
        params.append('modo', '@Model.Modo');
        @if (Model.IsVersionMode && Model.VersionId.HasValue)
        {
            <text>params.append('versionId', '@Model.VersionId');</text>
        }

        fetch('/Compare?handler=SuggestMerge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body: params.toString()
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            document.getElementById('mergeLoading').style.display = 'none';

            if (data.error) {
                document.getElementById('mergeError').textContent = data.error;
                document.getElementById('mergeError').style.display = '';
                return;
            }

            document.getElementById('mergeExplanation').textContent = data.explanation || '';
            document.getElementById('mergeExplanation').style.display = data.explanation ? '' : 'none';
            document.getElementById('mergeSqlCode').textContent = data.mergedSql || '';
            document.getElementById('mergeTokenInfo').textContent =
                'Modelo: ' + (data.model || '') +
                ' | Tokens: ' + (data.inputTokens || 0) + ' entrada + ' +
                (data.outputTokens || 0) + ' salida';
            document.getElementById('mergeResult').style.display = '';
        })
        .catch(function(err) {
            document.getElementById('mergeLoading').style.display = 'none';
            document.getElementById('mergeError').textContent = 'Error de conexion: ' + err.message;
            document.getElementById('mergeError').style.display = '';
        });
    }

    function copyMergedSql(btn) {
        var text = document.getElementById('mergeSqlCode')?.textContent || '';
        navigator.clipboard.writeText(text).then(function() {
            var icon = btn.querySelector('i');
            icon.className = 'bi bi-clipboard-check';
            btn.classList.replace('btn-outline-light', 'btn-success');
            setTimeout(function() {
                icon.className = 'bi bi-clipboard';
                btn.classList.replace('btn-success', 'btn-outline-light');
            }, 2000);
        });
    }

    // ===== Init on page load =====
    document.addEventListener('DOMContentLoaded', function() {
        initLayout();

        if (document.querySelectorAll('#objectGrid .object-row').length > 0) {
            filterStatus('Modified');
        }
        updateSyncCount();
        updateGridRowCount();

        var errorModal = document.getElementById('errorModal');
        if (errorModal) new bootstrap.Modal(errorModal).show();

        var syncErrorModal = document.getElementById('syncErrorModal');
        if (syncErrorModal) new bootstrap.Modal(syncErrorModal).show();
    });
</script>
}
